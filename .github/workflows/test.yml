name: Test Workflow

on:
    push:

permissions:
    contents: write

jobs:
    test:
        runs-on: ubuntu-slim
        steps:
            - name: Create dummy files
              run: |
                    mkdir -p dist-bin/
                    for os in darwin linux windows; do
                        for arch in x64 arm64; do
                            mkdir -p dist-bin/${os}-${arch}/
                            echo "#!/usr/bin/env bash\necho hi" > dist-bin/${os}-${arch}/copilot
                            chmod +x dist-bin/${os}-${arch}/copilot
                        done
                    done
                    ls -R dist-bin/

            - name: Zip / tar executables
              shell: bash
              working-directory: dist-bin
              run: |
                    for dir in */; do
                        cd $dir
                        if [[ "$dir" == *"windows/"* ]]; then
                            zip -r copilot-${dir%/}.zip copilot
                            mv copilot-${dir%/}.zip ..
                        else
                            tar -czf copilot-${dir%/}.tar.gz copilot
                            mv copilot-${dir%/}.tar.gz ..
                        fi
                        cd ..
                    done
            
            - name: Create release
              shell: bash
              run: |
                gh release create v0.0.${{ github.run_number }} \
                  --title "v0.0.${{ github.run_number }}" \
                  --repo ${{ github.repository }} \
                  --notes "Automated release" \
                  ./dist-bin/*.zip ./dist-bin/*.tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}